{% comment %}
  Countify Countdown Block
  Advanced countdown timer with multiple styles and customization options
{% endcomment %}

{% liquid
  assign target_date = block.settings.target_date | split: '.'
  assign target_time = block.settings.target_time | default: '00:00'
  
  assign target_timestamp = target_date[2] | append: '-' | append: target_date[1] | append: '-' | append: target_date[0] | append: 'T' | append: target_time | append: ':00'
  
  assign now = 'now' | date: '%s'
  assign target_seconds = target_timestamp | date: '%s'
  
  assign is_expired = false
  if target_seconds != blank and now > target_seconds
    assign is_expired = true
  endif
%}

<style>
.countify-countdown {
  position: relative;
  transition: all 0.3s ease;
}

.countify-countdown.hidden {
  display: none !important;
}

/* Countdown Container */
.countdown-container {
  display: none;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
  padding: 20px;
  background: {{ block.settings.background_color | default: 'rgba(0, 0, 0, 0.05)' }};
  border-radius: {{ block.settings.border_radius | default: '12' }}px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  text-align: {{ block.settings.text_alignment | default: 'center' }};
}

.countdown-container.expired {
  background: {{ block.settings.expired_background_color | default: 'rgba(255, 0, 0, 0.1)' }};
  color: {{ block.settings.expired_text_color | default: '#d32f2f' }};
  font-weight: bold;
}

/* Digital Style */
.countdown-digital {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.countdown-unit {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 70px;
  padding: 15px;
  background: {{ block.settings.unit_background_color | default: '#ffffff' }};
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid {{ block.settings.unit_border_color | default: 'rgba(0, 0, 0, 0.1)' }};
}

.countdown-value {
  font-size: {{ block.settings.value_font_size | default: '2.5' }}rem;
  font-weight: bold;
  color: {{ block.settings.value_color | default: '#333' }};
  line-height: 1;
  font-family: 'Courier New', monospace;
}

.countdown-label {
  font-size: {{ block.settings.label_font_size | default: '0.875' }}rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 8px;
  opacity: 0.7;
  font-weight: 500;
  color: {{ block.settings.label_color | default: '#666' }};
}

/* Flip Card Style */
.countdown-flip {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.flip-card {
  position: relative;
  width: 80px;
  height: 100px;
  perspective: 1000px;
}

.flip-card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  text-align: center;
  transition: transform 0.6s;
  transform-style: preserve-3d;
}

.flip-card.flipped .flip-card-inner {
  transform: rotateY(180deg);
}

.flip-card-front, .flip-card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: {{ block.settings.unit_background_color | default: '#ffffff' }};
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.flip-card-back {
  transform: rotateY(180deg);
  background: {{ block.settings.unit_background_color | default: '#f5f5f5' }};
}

.flip-value {
  font-size: {{ block.settings.value_font_size | default: '2' }}rem;
  font-weight: bold;
  color: {{ block.settings.value_color | default: '#333' }};
  line-height: 1;
}

.flip-label {
  font-size: {{ block.settings.label_font_size | default: '0.75' }}rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 5px;
  opacity: 0.7;
  color: {{ block.settings.label_color | default: '#666' }};
}

/* Circular Style */
.countdown-circular {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
  justify-content: center;
}

.circular-progress {
  position: relative;
  width: 120px;
  height: 120px;
}

.circular-svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.circular-bg {
  fill: none;
  stroke: rgba(0, 0, 0, 0.1);
  stroke-width: 8;
}

.circular-progress-bar {
  fill: none;
  stroke: {{ block.settings.progress_color | default: '#007cba' }};
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease-in-out;
}

.circular-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.circular-value {
  font-size: {{ block.settings.value_font_size | default: '1.5' }}rem;
  font-weight: bold;
  color: {{ block.settings.value_color | default: '#333' }};
  line-height: 1;
}

.circular-label {
  font-size: {{ block.settings.label_font_size | default: '0.75' }}rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 5px;
  opacity: 0.7;
  color: {{ block.settings.label_color | default: '#666' }};
}

/* Minimal Style */
.countdown-minimal {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
}

.minimal-unit {
  display: flex;
  align-items: center;
  gap: 5px;
}

.minimal-value {
  font-size: {{ block.settings.value_font_size | default: '1.5' }}rem;
  font-weight: bold;
  color: {{ block.settings.value_color | default: '#333' }};
}

.minimal-label {
  font-size: {{ block.settings.label_font_size | default: '0.875' }}rem;
  opacity: 0.7;
  color: {{ block.settings.label_color | default: '#666' }};
}

.minimal-separator {
  font-size: 1.2rem;
  opacity: 0.5;
  margin: 0 5px;
  color: {{ block.settings.value_color | default: '#333' }};
}

/* Responsive Design */
@media (max-width: 768px) {
  .countdown-digital {
    gap: 15px;
  }
  
  .countdown-unit {
    min-width: 60px;
    padding: 12px;
  }
  
  .countdown-value {
    font-size: {{ block.settings.value_font_size | default: '2' }}rem;
  }
  
  .flip-card {
    width: 70px;
    height: 90px;
  }
  
  .flip-value {
    font-size: {{ block.settings.value_font_size | default: '1.5' }}rem;
  }
  
  .circular-progress {
    width: 100px;
    height: 100px;
  }
  
  .circular-value {
    font-size: {{ block.settings.value_font_size | default: '1.25' }}rem;
  }
  
  .minimal-value {
    font-size: {{ block.settings.value_font_size | default: '1.25' }}rem;
  }
}

@media (max-width: 480px) {
  .countdown-container {
    padding: 15px;
  }
  
  .countdown-digital {
    gap: 10px;
  }
  
  .countdown-unit {
    min-width: 55px;
    padding: 10px;
  }
  
  .countdown-value {
    font-size: {{ block.settings.value_font_size | default: '1.5' }}rem;
  }
  
  .flip-card {
    width: 60px;
    height: 80px;
  }
  
  .flip-value {
    font-size: {{ block.settings.value_font_size | default: '1.25' }}rem;
  }
  
  .circular-progress {
    width: 80px;
    height: 80px;
  }
  
  .circular-value {
    font-size: {{ block.settings.value_font_size | default: '1' }}rem;
  }
  
  .minimal-value {
    font-size: {{ block.settings.value_font_size | default: '1' }}rem;
  }
}
</style>

<div id="countify-countdown-{{ block.id }}"
     class="countify-countdown countdown-theme-{{ block.settings.color_theme | default: 'primary' }}"
     data-settings='{
       "target_datetime": "{{ target_timestamp }}",
       "countdown_style": "{{ block.settings.countdown_style | default: 'digital' }}",
       "show_days": {{ block.settings.show_days | default: true }},
       "show_hours": {{ block.settings.show_hours | default: true }},
       "show_minutes": {{ block.settings.show_minutes | default: true }},
       "show_seconds": {{ block.settings.show_seconds | default: true }},
       "expired_message": "{{ block.settings.expired_message | default: 'Time\'s up!' | escape }}",
       "animation": "{{ block.settings.animation | default: 'none' }}"
     }'
     style="{% unless request.design_mode %}display:none!important;{% endunless %}">

  {% if request.design_mode %}
  <div style="padding: 20px; border: 2px dashed #007cba; border-radius: 8px; background: rgba(0, 124, 186, 0.05); margin: 20px 0;">
    <div style="color: #007cba; font-weight: bold; margin-bottom: 10px;">Countify Countdown</div>
    <div style="color: #666; font-size: 14px;">
      {% if block.settings.target_date %}
        Target: {{ block.settings.target_date }} {{ block.settings.target_time | default: '00:00' }}
      {% else %}
        No target date set
      {% endif %}
    </div>
    <div style="color: #666; font-size: 14px; margin-top: 5px;">
      Style: {{ block.settings.countdown_style | default: 'digital' | capitalize }}
    </div>
  </div>
  {% endif %}

  <div class="countdown-container countdown-{{ block.settings.countdown_style | default: 'digital' }} {{ block.settings.animation | default: 'none' }}">
    {% if block.settings.countdown_style == 'digital' %}
      <div class="countdown-digital">
        {% if block.settings.show_days %}
          <div class="countdown-unit">
            <div id="days-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Days</div>
          </div>
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="countdown-unit">
            <div id="hours-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Hours</div>
          </div>
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="countdown-unit">
            <div id="minutes-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Minutes</div>
          </div>
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="countdown-unit">
            <div id="seconds-{{ block.id }}" class="countdown-value">00</div>
            <div class="countdown-label">Seconds</div>
          </div>
        {% endif %}
      </div>
    {% elsif block.settings.countdown_style == 'flip' %}
      <div class="countdown-flip">
        {% if block.settings.show_days %}
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <div id="days-{{ block.id }}" class="flip-value">00</div>
                <div class="flip-label">Days</div>
              </div>
              <div class="flip-card-back">
                <div id="days-{{ block.id }}-back" class="flip-value">00</div>
                <div class="flip-label">Days</div>
              </div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <div id="hours-{{ block.id }}" class="flip-value">00</div>
                <div class="flip-label">Hours</div>
              </div>
              <div class="flip-card-back">
                <div id="hours-{{ block.id }}-back" class="flip-value">00</div>
                <div class="flip-label">Hours</div>
              </div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <div id="minutes-{{ block.id }}" class="flip-value">00</div>
                <div class="flip-label">Minutes</div>
              </div>
              <div class="flip-card-back">
                <div id="minutes-{{ block.id }}-back" class="flip-value">00</div>
                <div class="flip-label">Minutes</div>
              </div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="flip-card">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <div id="seconds-{{ block.id }}" class="flip-value">00</div>
                <div class="flip-label">Seconds</div>
              </div>
              <div class="flip-card-back">
                <div id="seconds-{{ block.id }}-back" class="flip-value">00</div>
                <div class="flip-label">Seconds</div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    {% elsif block.settings.countdown_style == 'circular' %}
      <div class="countdown-circular">
        {% if block.settings.show_days %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-days="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="days-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Days</div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-hours="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="hours-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Hours</div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-minutes="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="minutes-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Minutes</div>
            </div>
          </div>
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="circular-progress">
            <svg class="circular-svg">
              <circle class="circular-bg" cx="60" cy="60" r="52"></circle>
              <circle class="circular-progress-bar" cx="60" cy="60" r="52" data-seconds="{{ block.id }}"></circle>
            </svg>
            <div class="circular-content">
              <div id="seconds-{{ block.id }}" class="circular-value">00</div>
              <div class="circular-label">Seconds</div>
            </div>
          </div>
        {% endif %}
      </div>
    {% elsif block.settings.countdown_style == 'minimal' %}
      <div class="countdown-minimal">
        {% if block.settings.show_days %}
          <div class="minimal-unit">
            <div id="days-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">d</div>
          </div>
          {% if block.settings.show_hours or block.settings.show_minutes or block.settings.show_seconds %}
            <div class="minimal-separator">:</div>
          {% endif %}
        {% endif %}
        {% if block.settings.show_hours %}
          <div class="minimal-unit">
            <div id="hours-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">h</div>
          </div>
          {% if block.settings.show_minutes or block.settings.show_seconds %}
            <div class="minimal-separator">:</div>
          {% endif %}
        {% endif %}
        {% if block.settings.show_minutes %}
          <div class="minimal-unit">
            <div id="minutes-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">m</div>
          </div>
          {% if block.settings.show_seconds %}
            <div class="minimal-separator">:</div>
          {% endif %}
        {% endif %}
        {% if block.settings.show_seconds %}
          <div class="minimal-unit">
            <div id="seconds-{{ block.id }}" class="minimal-value">00</div>
            <div class="minimal-label">s</div>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<script src="{{ 'countify-countdown.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Countify Countdown",
  "target": "section",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "⏰ Countdown Settings"
    },
    {
      "type": "text",
      "id": "target_date",
      "label": "Target Date",
      "placeholder": "DD.MM.YYYY",
      "info": "The date when the countdown should end"
    },
    {
      "type": "text",
      "id": "target_time",
      "label": "Target Time",
      "placeholder": "23:59",
      "default": "00:00",
      "info": "The time when the countdown should end"
    },
    {
      "type": "text",
      "id": "expired_message",
      "label": "Expired Message",
      "default": "Time's up!",
      "info": "Message shown when countdown expires"
    },
    {
      "type": "header",
      "content": "🎨 Style Settings"
    },
    {
      "type": "select",
      "id": "countdown_style",
      "label": "Countdown Style",
      "options": [
        { "value": "digital", "label": "Digital Clock" },
        { "value": "flip", "label": "Flip Cards" },
        { "value": "circular", "label": "Circular Progress" },
        { "value": "minimal", "label": "Minimal" }
      ],
      "default": "digital"
    },
    {
      "type": "select",
      "id": "color_theme",
      "label": "Color Theme",
      "options": [
        { "value": "primary", "label": "Primary" },
        { "value": "success", "label": "Success" },
        { "value": "warning", "label": "Warning" },
        { "value": "danger", "label": "Danger" }
      ],
      "default": "primary"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "animation",
      "label": "Animation",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "pulse", "label": "Pulse" },
        { "value": "fadeInUp", "label": "Fade In Up" },
        { "value": "slideIn", "label": "Slide In" }
      ],
      "default": "none"
    },
    {
      "type": "header",
      "content": "📊 Display Options"
    },
    {
      "type": "checkbox",
      "id": "show_days",
      "label": "Show Days",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_hours",
      "label": "Show Hours",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_minutes",
      "label": "Show Minutes",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_seconds",
      "label": "Show Seconds",
      "default": true
    },
    {
      "type": "header",
      "content": "🎨 Custom Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "rgba(0, 0, 0, 0.05)"
    },
    {
      "type": "color",
      "id": "value_color",
      "label": "Value Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "unit_background_color",
      "label": "Unit Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "unit_border_color",
      "label": "Unit Border Color",
      "default": "rgba(0, 0, 0, 0.1)"
    },
    {
      "type": "color",
      "id": "progress_color",
      "label": "Progress Color (Circular)",
      "default": "#007cba"
    },
    {
      "type": "color",
      "id": "expired_background_color",
      "label": "Expired Background Color",
      "default": "rgba(255, 0, 0, 0.1)"
    },
    {
      "type": "color",
      "id": "expired_text_color",
      "label": "Expired Text Color",
      "default": "#d32f2f"
    },
    {
      "type": "header",
      "content": "📏 Typography"
    },
    {
      "type": "range",
      "id": "value_font_size",
      "label": "Value Font Size",
      "min": 1,
      "max": 4,
      "step": 0.1,
      "default": 2.5,
      "unit": "rem"
    },
    {
      "type": "range",
      "id": "label_font_size",
      "label": "Label Font Size",
      "min": 0.5,
      "max": 1.5,
      "step": 0.05,
      "default": 0.875,
      "unit": "rem"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 30,
      "step": 1,
      "default": 12,
      "unit": "px"
    }
  ]
}
{% endschema %}
