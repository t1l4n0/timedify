{% comment %}
  Timed Content: Start Block
  This block marks the beginning of time-controlled content
{% endcomment %}

{% comment %}Check subscription status first{% endcomment %}
{% liquid
  # Read subscription status from shop metafield
  assign metafield = shop.metafields.timedify.subscription_active
  assign subscription_active = false
  
  # Try different ways to read the metafield value
  if metafield and metafield.value
    assign subscription_active = metafield.value
  elsif metafield and metafield.value == blank
    assign subscription_active = false
  else
    # Metafield doesn't exist yet - assume inactive for security
    assign subscription_active = false
  endif
  
  # Convert to boolean
  if subscription_active == 'true' or subscription_active == true or subscription_active == 1
    assign should_load = true
  else
    assign should_load = false
  endif
%}

{% if request.design_mode and should_load == false %}
  <div style="padding:12px;border:1px solid #ffc107;border-radius:4px;margin:10px 0;background:#fff8e1;font-size:12px;">
    <div style="color:#856404;font-weight:bold;">⚠️ Active subscription required</div>
    <div style="color:#856404;font-size:11px;">Activate Timedify subscription to use this block.</div>
  </div>
{% endif %}

{% if should_load %}
{% liquid
  assign start_date = block.settings.start_date | split: '.'
  assign start_time = block.settings.start_time | default: '00:00'
  
  assign start_timestamp = start_date[2] | append: '-' | append: start_date[1] | append: '-' | append: start_date[0] | append: 'T' | append: start_time | append: ':00'
  
  assign now = 'now' | date: '%s'
  assign start_seconds = start_timestamp | date: '%s'
  
  assign should_show = false
  if start_seconds == blank
    assign should_show = true
  elsif now >= start_seconds
    assign should_show = true
  endif
  
%}

{% if request.design_mode %}
<style>
.timedify-editor-spacing { margin: 32px 0; }
/* Zentrierung der Anzeige im Editor */
.timed-sections-start .ts-marker { text-align: center; }
.timed-sections-start .ts-display-only,
.timed-sections-start .ts-display-label,
.timed-sections-start .ts-display-value { text-align: center; }
</style>
{% endif %}

<style>
.ts-hidden { display: none !important; }

.ts-display-only {
  color: #333;
  font-size: 14px;
  line-height: 1.4;
}

.ts-display-label {
  font-weight: 600;
  color: #198754;
  margin-bottom: 8px;
}

.ts-display-value {
  color: #333;
  margin: 4px 0;
}

.ts-marker {
  padding: 12px;
  border: 2px dashed #198754;
  border-radius: 6px;
  background: rgba(25,135,84,.06);
  font-size: 14px;
  text-align: center;
}
</style>

{% if request.design_mode %}<div class="timedify-editor-spacing">{% endif %}
<div id="timed-sections-start-{{ block.id }}"
     class="timed-sections-start"
     data-start-datetime="{% if block.settings.start_date %}{{ block.settings.start_date }} {{ block.settings.start_time | default: '00:00' }}{% endif %}"
     style="{% unless request.design_mode %}display:none!important;{% endunless %}">
  {% if request.design_mode %}
  <div class="ts-marker">
    <div class="ts-display-only">
      <div class="ts-display-label">Timed Content starts here:</div>
      
      {% if block.settings.start_date %}
        <div class="ts-display-value">Start: {{ block.settings.start_date }}{% if block.settings.start_time and block.settings.start_time != blank and block.settings.start_time != '' and block.settings.start_time != ' ' %} {{ block.settings.start_time }}{% else %} 0:00{% endif %}</div>
      {% else %}
        <div class="ts-display-value" style="color: #155724;">
          Always visible (no dates set)
        </div>
      {% endif %}
      
    </div>
  </div>
  {% else %}
  <!-- Display only on storefront -->
  <div class="ts-display-only">
    <strong>Timed Content starts here:</strong><br>
    {% if block.settings.start_date %}
      Start: {{ block.settings.start_date }}{% if block.settings.start_time and block.settings.start_time != blank and block.settings.start_time != '' and block.settings.start_time != ' ' %} {{ block.settings.start_time }}{% else %} 0:00{% endif %}
    {% else %}
      Always visible
    {% endif %}
  </div>
  {% endif %}
</div>

{% comment %}
  Content visibility control - hide immediately if expired
{% endcomment %}
<div id="timed-sections-content-{{ block.id }}" 
     class="timed-sections-content{% unless should_show %} ts-hidden{% endunless %}"
     data-should-show="{{ should_show }}">
  <!-- Content will be placed here by JavaScript -->
</div>
{% if request.design_mode %}</div>{% endif %}

{%- comment -%} Script wird zentral im Snippet `timedify-subscription-check` geladen, um Doppel-Laden zu vermeiden {%- endcomment -%}
{% elsif request.design_mode %}
  <div class="timedify-editor-spacing">
  <div class="ts-marker" style="padding:12px;border:1px solid #ffc107;border-radius:4px;background:#fff8e1;font-size:12px;">
    <div style="color: #856404; font-weight: bold; margin-bottom: 4px;">
      ⚠️ Timedify: Active subscription required
    </div>
    <div style="color: #856404; font-size: 11px;">
      This start block is disabled. Please activate your Timedify subscription to use timed content features.
    </div>
  </div>
  </div>
{% endif %}

{% if should_load %}
  <script src="{{ 'timed-sections.js' | asset_url }}" defer></script>
{% endif %}

{% schema %}
{
  "name": "⏰ 1. Timed Content: Start",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "⏰ Time Settings"
    },
    {
      "type": "text",
      "id": "start_date",
      "label": "Start Date",
      "placeholder": "DD.MM.YYYY",
      "default": "01.01.2025"
    },
    {
      "type": "text",
      "id": "start_time",
      "label": "Start Time",
      "placeholder": "09:00",
      "default": "00:00"
    }
  ]
}
{% endschema %}
