{% comment %}
  Timed Content End Block - marks the end of time-controlled content
{% endcomment %}

{% comment %}Check subscription status first{% endcomment %}
{% liquid
  # Read subscription status from shop metafield
  assign metafield = shop.metafields.timedify.subscription_active
  assign subscription_active = false
  
  # Try different ways to read the metafield value
  if metafield and metafield.value
    assign subscription_active = metafield.value
  elsif metafield and metafield.value == blank
    assign subscription_active = false
  else
    # Metafield doesn't exist yet - assume inactive for security
    assign subscription_active = false
  endif
  
  # Convert to boolean
  if subscription_active == 'true' or subscription_active == true or subscription_active == 1
    assign should_load = true
  else
    assign should_load = false
  endif
%}

{% if request.design_mode and should_load == false %}
  <div style="padding:12px;border:1px solid #ffc107;border-radius:4px;margin:10px 0;background:#fff8e1;font-size:12px;">
    <div style="color:#856404;font-weight:bold;">‚ö†Ô∏è Active subscription required</div>
    <div style="color:#856404;font-size:11px;">Activate Timedify subscription to use this block.</div>
  </div>
{% endif %}

{% if should_load %}
{% liquid
  # Content type will be determined by JavaScript controller
  # Liquid cannot reliably detect app blocks in JSON templates
  assign content_type = 'auto-detect'
%}

{% comment %}All timing logic now handled by JavaScript controller{% endcomment %}

{% if request.design_mode %}
<style>
.timedify-editor-spacing { margin: 32px 0; }
</style>
{% endif %}
<style>
.ts-hidden { display: none !important; }

.ts-end-marker {
  padding: 12px;
  border: 2px dashed #dc3545;
  border-radius: 6px;
  background: rgba(220, 53, 69, 0.06);
  font-size: 14px;
  text-align: center;
}
</style>

{% if request.design_mode %}<div class="timedify-editor-spacing">{% endif %}
<div id="timed-sections-end-{{ block.id }}"
     class="timed-sections-end"
     data-end-datetime="{% if block.settings.end_date %}{{ block.settings.end_date }} {{ block.settings.end_time | default: '23:59' }}{% endif %}"
     data-content-type="{{ content_type }}"
     style="{% unless request.design_mode %}display:none!important;{% endunless %}">
  {% if request.design_mode %}
  <div class="ts-end-marker">
    <div style="color: #dc3545; font-weight: 600; text-align: center;">
      Timed Content ends here.
    </div>
    {% if block.settings.end_date %}
      <div class="ts-display-only" style="text-align: center; margin-top: 6px;">
        End: {{ block.settings.end_date }}{% if block.settings.end_time and block.settings.end_time != blank and block.settings.end_time != '' and block.settings.end_time != ' ' %} {{ block.settings.end_time }}{% else %} 23:59{% endif %}
      </div>
    {% endif %}
    
    <div style="margin-top: 8px; padding: 8px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; font-size: 11px;">
      <div style="color: #0c5460;">
        üí° Make sure to place a "Timed Content: Start" block before your content to control when it becomes visible.
      </div>
    </div>
  </div>
  {% else %}
  <!-- Display only on storefront -->
  <div style="color: #dc3545; font-weight: 600; text-align: center;">
    Timed Content ends here.
  </div>
  {% if block.settings.end_date %}
    <div class="ts-display-only" style="text-align: center; margin-top: 6px;">
      End: {{ block.settings.end_date }}{% if block.settings.end_time and block.settings.end_time != blank and block.settings.end_time != '' and block.settings.end_time != ' ' %} {{ block.settings.end_time }}{% else %} 23:59{% endif %}
    </div>
  {% endif %}
  {% endif %}
</div>
{% if request.design_mode %}</div>{% endif %}
{% elsif request.design_mode %}
<div class="timedify-editor-spacing">
<div class="ts-end-marker" style="padding:12px;border:1px solid #ffc107;border-radius:4px;background:#fff8e1;font-size:12px;">
  <div style="color: #856404; font-weight: bold; margin-bottom: 4px;">
    ‚ö†Ô∏è Timedify: Active subscription required
  </div>
  <div style="color: #856404; font-size: 11px;">
    This end block is disabled. Please activate your Timedify subscription to use timed content features.
  </div>
</div>
</div>
{% endif %}

{% schema %}
{
  "name": "‚è∞ 2. Timed Content: End",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "‚è∞ End Time Settings"
    },
    {
      "type": "text",
      "id": "end_date",
      "label": "End Date",
      "placeholder": "DD.MM.YYYY",
      "default": "31.12.2025"
    },
    {
      "type": "text",
      "id": "end_time",
      "label": "End Time",
      "placeholder": "18:00",
      "default": "23:59"
    }
  ]
}
{% endschema %}